---
title: "ECON 773: Assignment 3"
author: "The BLUE Team, Jeneta Ljutic (400138620), Tadhg Taylor-McGreal (400330297), Stella Till (400364649)"
date: "Febuary 4"
format:
  typst:
    toc: TRUE
---

{{< pagebreak >}}

# Preface

## Goal

The goals of this assignment are to:

- use regression adjustment and inverse propensity score weighting to analyze the effect of a treatment in the presence of observed confounders (selection on observables)
- use instrumental variables estimation to analyze the effect of a treatment with unobserved confounders (selection on unobservables)

## Instructions

See assignment 1.

In the remainder of this assignment, we will use the following packages:

- `tidyverse` for data transformation and plotting
- `haven` to load Stata data files
- `gt` for making tables
- `gtsummary` for summarizing and visualizing tibbles and model output
- `estimatr` for linear regression for causal inference
- `WeightIt` for estimating propensity scores and implementing the IPW estimator
- `cobalt` for visualizing the results of the propensity score matching

Make sure that they are installed, or use `install.packages` to install them. 
The following code block makes sure these packages are available below, without adding to your page count.

```{r}
#| include: false
library(tidyverse)
library(haven)
library(gt)
library(gtsummary)
library(estimatr)
library(WeightIt)
library(cobalt)
```

{{< pagebreak >}}

# School choice and student achievement ### treat as a delimination. 

## Introduction

We will investigate the effect of attending a Catholic school on student achievement, inspired by the analysis in [Elder and Jepsen (2014)](https://doi.org/10.1016/j.jue.2013.10.001). We will use their data, which originates from the [Early Childhood Longitudinal Study](https://nces.ed.gov/ecls/).

For some background on the Catholic school effect, read [this very short overview](https://edpolicy.education.jhu.edu/is-the-catholic-school-effect-real-new-research-challenges-the-catholic-primary-school-advantage/), which also features the Elder and Jepsen (2014) paper. 

The following code chunk loads the `tidyverse` suite of packages and then loads the data from a CSV file into a tibble `exam_df`.
```{r}
exam_df <- read_csv("examdata.csv")
```

We will use 3rd grade scores on a math test as the outcome that measures student achievement. The code chunk below renames this variable as `math_score`, and codes as `catholic` the binary treatment variable that indicates whether a child attends a Catholic school (1) or not (0). It also keeps five possible confounders, described in the comment of the code chunk.

```{r}
exam_df <- exam_df |> mutate(
  math_score = c5r2mtsc_std,
  catholic = factor(catholic),
  white = factor(race_white),  # is the student white (1) or not (0)
  mum_age = p5hmage,           # mother's age
  mum_educ_high = factor(1-w3momed_hsb), 
    # mother's education, <= high-school (0), >= college (1)
  n_places = p5numpla, # number of places the student has lived
  income = w3income,   # family income
  .keep = "none"
  )
```

## Summary statistics

It is good practice to inspect the data before doing any modeling. This gives us an idea of what the data looks like.

1. Use `tbl_summary` from the `gtsummary` package to display a table of summary statistics for all variables.
2. Pick one statistic from the resulting table and comment on it.

### Answer

...


## Linear regression

Ignoring treatment selection bias, is there a difference between Catholic and public school students in terms of the mean of the outcome variable? Answer this question in two ways. 

1. Use linear regression, via `lm_robust` in the `estimatr` package, to estimate the DIM. Save the resulting model object as `exam_ols`, print a summary to the screen, and interpret the result.
2. Make a boxplot, split and coloured by `catholic`, to visualize the difference in the distribution of outcomes between the two groups. Interpret the result.

### Answer

...


## Covariate balance

We can use `tbl_summary` to create a summary table for each value of the treatment variables. This is sometimes called a covariate balance table:

```{r}
exam_df |> 
  tbl_summary(by = catholic)  #|> 
  # add_overall() |> 
  # add_p()
```

Interpret the result.

### Answer

...


## Regression adjustment

Run a linear regression that adjusts for all of the five confounders, using the `lm_lin` function in `estimatr`. Save the resulting model object in `exam_ra`, and print a summary to the screen. 

1. Interpret the result.
2. Explain the difference between this and your previous results in `exam_ols`.
3. Pick one of the confounders. Comment on the coefficient on $X$, and on $D X$.

### Answer

...


## Propensity score

Estimate the propensity score by running a logit model where the outcome variable is `catholic` and the regressors are the five confounders. Save the model object as `m_ps`. Interpret the coefficient estimates.

Here is how you can run this propensity score regression:

```{r}
m_ps <- glm(
  catholic ~ white + mum_educ_high + income + n_places + mum_age, 
  family = binomial(), 
  data = exam_df)
m_ps |>
  tbl_regression(estimate_fun = ~ style_number(.x, digits = 2)) |>
  modify_column_unhide(columns = std.error) |>
  modify_column_hide(columns = p.value)
```

Can you interpret the results?

### Answer

...


## Overlap

You can use `predict` to calculate the propensity score for each student, and add it as a new variable `p_hat` to the `exam_df` tibble.
This is each student's predicted probability of being treated, given the estimates from the logit model:

```{r}
exam_df |> mutate(
  p_hat = predict(m_ps, type = "response")
) -> exam_df
```

1. Make a boxplot of the propensity scores, coloured by `catholic`, to visualize the difference in the distribution of propensity scores between the two groups.
2. Does the overlap condition appear to hold?

### Answer

...


## Covariate balance

We use the `WeightIt` package, documented [here](https://ngreifer.github.io/WeightIt/), for estimating propensity scores and for implementing the IPW estimator.

Start by re-estimating the propensity score using the methods in this package:

```{r}
W <- weightit(
  catholic ~ white + mum_educ_high + income + n_places + mum_age, 
  data = exam_df, method = "glm", estimand = "ATE")
summary(W)
```

`WeightIt` works well with the `cobalt` package, documented [here](https://ngreifer.github.io/cobalt/).

```{r}
bal.tab(W, un = TRUE)
```

This output does not look as nice as our usual tabular output, which is fine for now.

1. Interpret the balance table.
2. Make a `love.plot` to visualize the balance of the covariates across the two groups before and after reweighting. You may have to do some research to find out (1) how to use that function; (2) what a love plot is.
3. Comment on the result.

### Answer

...


## IPW estimator

We can now compute the IPW estimator using the `lm_weightit` function in the `WeightIt` package. Save the resulting model object as `exam_ipw`. 
Print the results to the screen using `summary(exam_ipw)`.
Interpret the finding. 

### Answer

...


## Conclusion

Compare this to the result from regression adjustment and to the original naive regression without controls. 
What do you conclude about the effect of attending a Catholic school? 

### Answer

...


# Lalonde

You will analyze the effect, for men, of participating in the [National Supported Work Demonstration](https://www.mdrc.org/work/publications/summary-and-findings-national-supported-work-demonstration) on subsequent earnings.

The next code chunk loads the data from the `cobalt` package we used above, and extracts it into a tibble `nsw_df`. Make sure that package is installed to avoid errors.

```{r}
data("lalonde", package = "cobalt")
nsw_df <- as_tibble(lalonde) |> select(-re75)
```

The treatment indicator (1 if treated, 0 if not) is `treat`.
The outcome of interest is real earnings in 1978, `re78`.

We summarize the variables, split out by `treat`:

```{r}
nsw_df |>
    tbl_summary(by = treat)
```

The variables in this table that we have not yet discussed are `age` (in years), `educ` (in years), `race` ("black", "hispanic", "white"), `married` (1 if married, 0 otherwise), `nodegree` (1 if no degree, 0 otherwise), and `re74` (real earnings in 1974).

Based on the table above:

1. Choose 3 confounders.
2. Repeat all the steps that we took to analyze the effect of `catholic` on `math_score` above. Make sure to interpret your results along the way.

### Answer

...


{{< pagebreak >}}

# Effect of the Hajj ('hadge') on religion and tolerance

You are going to replicate a paper by Clingingsmith et al. (2009, Quarterly Journal of Economics) entitled [Estimating the Impact of The Hajj: Religion and Tolerance in Islam's Global Gathering](https://doi.org/10.1162/qjec.2009.124.3.1133), which finds that:

The Quran mandates that every Muslim completes the Hajj pilgrimage once in their lifetime, provided that they are physically and financially able to do so.

> We estimate the impact on pilgrims of performing the Hajj pilgrimage to Mecca. Our method compares successful and unsuccessful applicants in a lottery used by Pakistan to allocate Hajj visas. Pilgrim accounts stress that the Hajj leads to a feeling of unity with fellow Muslims, but outsiders have sometimes feared that this could be accompanied by antipathy toward non-Muslims. We find that participation in the Hajj increases observance of global Islamic practices, such as prayer and fasting, while decreasing participation in localized practices and beliefs, such as the use of amulets and dowry. It increases belief in equality and harmony among ethnic groups and Islamic sects and leads to more favorable attitudes toward women, including greater acceptance of female education and employment.

Previous ECON773 students have remarked that they thought the pilgrimage may not have such an effect, because it is mandated ("you have to do it"). Let us reanalyze the data to examine this claim.

Our analysis follows the replication by [Julia de Romemont](https://uclspp.github.io/PUBL0050/7-instrumental-variables-i.html). The following code chunk loads the data prepared by her:

```{r}
load("hajjdata.Rdata")
hajj_df <- as_tibble(hajj)
```

A data summary tells us:

```{r}
tbl_summary(hajj_df)
```

The outcome variable for our analysis is `moderacy`, an index ranging from 0 to 4 constructed from opinion questions, where higher values indicate more moderate views on Islamic practices.

The instrument variable is `success` (1 if the respondent won the lottery for a Hajj visa, 0 otherwise). The treatment variable is `hajj2006` (1 if the respondent went on the Hajj, 0 otherwise). Our main interest is in determining whether participating in the Hajj has an effect on `moderacy`.

Additional control variables in the data set are:

- `age` (in years)
- `literate` (1 if respondent is literate, 0 otherwise)
- `urban` (1 if respondent lives in an urban area, 0 otherwise)

Note that average age in this sample is quite high. It makes sense: people often leave this obligation for later in life, when they have time and the financial resources to undertake the pilgrimage.

## Compliance

1. Construct a crosstable of `success` and `hajj2006`, using `tbl_cross` from the `gtsummary` package, using `hajj_df |> tbl_cross(row = success, col = hajj2006)`.
2. Determine the proportion of people who won the lottery and did not go on the Hajj and the proportion of people who lost the lottery and went on the Hajj.
3. Describe what a never-taker, always-taker, complier, and defier is in this experiment.
4. Based on the table, do you think there are lots of compliers? Defiers? Always-takers? Never-takers?

### Answer

...


## First-stage regression

1. Run the first stage linear regression.
2. Are the results in line with the contingency table you made above?
3. Are you worried that the instrument is weak?
4. Add the first stage predictions as `hajj_hat` to the data set `hajj_df`.

### Answer

...


## Intention to treat

Compute the intention to treat (ITT) of $Z$ on $Y$ using `lm_robust`.
Interpret your finding.
To get a sense of scale, you can compare the coefficient on $Z$ to the standard deviation of $Y$.

### Answer

...


## Second stage

Now run the second stage regression, of $Y$ on $\widehat D$.

### Answer

...


## 2SLS

Even though the second stage regression may control for heteroskedasticity, it does not take into account that the first step was estimated. Use `iv_robust` to compute the 2SLS estimator.

### Answer

...


## Conclusion

Carefully interpret the 2SLS estimate.

### Answer

...


## Bonus question

How can you include covariates in this specification? Reestimate the effect while controlling for `literate` and `urban`.

### Answer

...


{{< pagebreak >}}

# The Sesame Street Experiment

The TV show [Sesame Street](https://en.wikipedia.org/wiki/Sesame_Street) was designed with educational outcomes in mind. Evidence that watching Sesame Street managed to do so was recently popularized by Malcolm Gladwell in [The Tipping Point](https://en.wikipedia.org/wiki/The_Tipping_Point). In economics, [Kearney and Levin, 2019, AEJ Applied](https://www.aeaweb.org/articles?id=10.1257/app.20170300) used observational data to show that it improved educational outcomes in children (particularly boys) growing up in the United States in the late 1960s and early 1970s.

We will analyze the Sesame Street using data from an experimental intervention.
Load the experimental data, from Stata format, using `haven::read_dta`.
Based on previous results, we are particularly interested in the effects on boys that are 50 months or younger. Therefore, we retain only those observations.

```{r}
sesame_df <- read_dta("sesame_experiment.dta") |> 
  filter(age < 51, female == 0)
```

In the experiment, children were randomly `encouraged` to watch the show (1 if child was encouraged to watch Sesame Street, and 0 otherwise).
The researchers observed the child's Sesame Street viewing behavior, and recorded it as the variable `watched` (0=rarely watched the show, 1= watched once/week or greater).
The researchers were interested in whether viewing Sesame Street improved educational outcomes. After the experiment, they conducted a test. A child's score on that test is recorded as `letters` (score between 0 and 58, higher is better).

## Question

1. Identify the instrument, treatment indicator, and outcome.
2. Repeat the analysis we did for the Hajj and determine the effect of watching Sesame Street on the `letters` test.

### Answer

...


## Bonus question 1

1. Do you find an effect for girls in the same age range?
2. Do you find an effect for older boys?

### Answer

...


## Bonus question 2

1. Here, are we interested in the effect of $D$ on $Y$ (LATE) or on the effect of $Z$ on $Y$ (ITT)?
2. Explain the difference between the two, and explain who may be interested in each of the two questions.

### Answer

...


